<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      /* Keyframes for the rotating gradient border */
      @keyframes rotate-border {
        0% {
          border-image-source: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet);
        }
        100% {
          border-image-source: linear-gradient(450deg, red, orange, yellow, green, blue, indigo, violet);
        }
      }

      /* Style for the button with rotating gradient animation */
      #preview-button {
        display: block;
        border-radius: 50px;
        background: transparent;
        color: white;
        padding: 10px 20px;
        font-size: 16px;
        text-align: center;
        cursor: pointer;
        border: 2px solid;
        border-image: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet) 1;
        animation: rotate-border 5s linear infinite;
      }

      /* Style when button is disabled */
      #preview-button:disabled {
        color: #aaa;
        border-image: none;
        background-color: #ddd;
        border: 2px solid #ccc;
        cursor: not-allowed;
        animation: none; /* Stop the gradient animation */
      }

      /* Style for the loading bar */
      #loading-bar {
        width: 100%;
        height: 10px;
        background-color: #f3f3f3;
        margin-top: 20px;
        overflow: hidden;
        display: none; /* Hidden by default */
        position: relative;
      }

      /* Inner loading bar animation */
      #loading-bar-inner {
        width: 0;
        height: 100%;
        background-color: #4caf50;
        animation: loading-animation 2s linear infinite;
      }

      /* Keyframes for the loading bar animation */
      @keyframes loading-animation {
        0% {
          width: 0%;
        }
        100% {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>

    <p style="font-size: 16px; margin-bottom: 10px; text-align: center;">
      Good design opens doors for allâ€”empowering people with dyslexia, low vision, color blindness, ADHD, epilepsy, autism, and beyond.
    </p>

    <sp-button id="preview-button" treatment="fill" variant="secondary">
      Analyze
    </sp-button>

    <!-- Loading bar container -->
    <div id="loading-bar">
      <div id="loading-bar-inner"></div>
    </div>

    <div
      style="
        height: 275px;
        width: 275px;
        border: 1px solid;
        border-color: lightgray;
        text-align: center;
        overflow-y: scroll;
        display: block;
        margin-top: 10%;
      "
      id="square"
    >
      <sp-field-label
        style="padding-top: 45%; padding-bottom: 50%; display: block"
        id="prev"
        size="l"
        >PREVIEW</sp-field-label
      >

    </div>

    <p style="font-size: 16px; margin-bottom: 10px; text-align: center;">
      Adapt these changes to make your design <strong>accessible</strong> to all.
    </p>

    <!-- Container for displaying analysis response -->
    <div id="analysis-results" style="margin-top: 20px; padding: 10px; border: 1px solid lightgray;">
    </div>

    <script type="module" defer>
      import AddOnSdk from "https://new.express.adobe.com/static/add-on-sdk/sdk.js";
      try {
        await AddOnSdk.ready;
      } catch (e) {
        console.error("SDK init failed:", e);
      }

      document.getElementById("preview-button").addEventListener("click", previewButtonClick);

      async function previewButtonClick() {
        const previewButton = document.getElementById("preview-button");
        previewButton.disabled = true; // Disable the button on click

        document.getElementById("prev").style.display = "block";

        // Show loading bar
        document.getElementById("loading-bar").style.display = "block";

        const renditionOptions = {
          range: "currentPage",
          format: "image/png",
        };

        const response = await AddOnSdk.app.document.createRenditions(renditionOptions);

        document.getElementById("prev").style.display = "none";

        if (response && response.length > 0) {
          const blob = response[0].blob;
          const azureStorageAccount = "gk4413blobstorage";
          const containerName = "images";
          const sasToken = "?sv=2023-01-03&ss=btqf&srt=sco&st=2024-11-03T03%3A04%3A31Z&se=2024-11-19T04%3A04%3A00Z&sp=rwl&sig=GifJLs7xUBpPEHcDXuX9Zn%2Fy8nyKgmDPLqPs0WgpPZ4%3D";
          const blobName = `preview-${Date.now()}.png`;
          const azureUrl = `https://${azureStorageAccount}.blob.core.windows.net/${containerName}/${blobName}${sasToken}`;

          try {
            const uploadResponse = await fetch(azureUrl, {
              method: "PUT",
              headers: {
                "x-ms-blob-type": "BlockBlob",
              },
              body: blob,
            });

            if (uploadResponse.ok) {
              const blobUrl = `https://${azureStorageAccount}.blob.core.windows.net/${containerName}/${blobName}`;
              const apiEndpoint = "https://9af0-68-180-87-191.ngrok-free.app/analyze";
              const analysisResponse = await fetch(apiEndpoint, {
                method: "POST",
                headers: {
                  'Accept': 'application/json',
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ url: blobUrl }),
              });
             
              const analysisText = await analysisResponse.text();

              // Hide loading bar
              document.getElementById("loading-bar").style.display = "none";

              displayAnalysisResults(analysisText);

              console.log("Image uploaded and API notified:", blobUrl);
            } else {
              console.error("Azure upload failed:", uploadResponse.statusText);
            }
          } catch (err) {
            console.error("Error during Azure upload:", err);
          }
        }

        previewButton.disabled = false; // Re-enable the button after completion
      }
    
      function displayAnalysisResults(analysisText) {
        const analysisData = JSON.parse(JSON.parse(analysisText).analysis);
        const analysisContainer = document.getElementById("analysis-results");
        analysisContainer.innerHTML = "";

        const ol = document.createElement("ul");

        Object.keys(analysisData).forEach((key, index) => {
          const issue = analysisData[key];
          const listItem = document.createElement("li");

          if (issue.Title) {
            const title = document.createElement("h3");
            title.textContent = `${index + 1}. ${issue.Title}`;
            listItem.appendChild(title);
          }

          if(issue.Description){
            const description = document.createElement("p");
            description.innerHTML = `<strong>Description:</strong> ${issue.Description}`;
            listItem.appendChild(description);
          }

          if(issue.Suggestion){
            const suggestion = document.createElement("p");
            suggestion.innerHTML = `<strong>Suggestion:</strong> ${issue.Suggestion}`;
            listItem.appendChild(suggestion);
          }

          if(issue.Importance_score){
            const importance = document.createElement("p");
            importance.innerHTML = `<strong>Importance Score:</strong> ${issue.Importance_score}`;
            listItem.appendChild(importance);
          }

          ol.appendChild(listItem);
        });

        analysisContainer.appendChild(ol);
      }

    </script>
  </body>
</html>
